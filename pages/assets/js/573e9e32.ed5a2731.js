"use strict";(self.webpackChunkspr_docs=self.webpackChunkspr_docs||[]).push([[515],{7192:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>u,frontMatter:()=>n,metadata:()=>o,toc:()=>c});var s=i(85893),a=i(11151);const n={slug:"spr-and-cups-multicast-vulnerability",title:"Locking Down Multicast Services with SPR",authors:["ltsrad"],tags:["firewall","multicast"]},r=void 0,o={permalink:"/pages/blog/spr-and-cups-multicast-vulnerability",source:"@site/blog/2024-09-26-firewalling-multicast.md",title:"Locking Down Multicast Services with SPR",description:"Here is an overview of how SPR helps defend users against attacks with multicast services. The capabilities let SPR users enjoy the benefits of multicast while also being able to constrain the attack surfaces to trusted devices only.",date:"2024-09-26T00:00:00.000Z",tags:[{inline:!0,label:"firewall",permalink:"/pages/blog/tags/firewall"},{inline:!0,label:"multicast",permalink:"/pages/blog/tags/multicast"}],readingTime:3.89,hasTruncateMarker:!0,authors:[{name:"Alex Radocea",url:"https://twitter.com/defendtheworld",key:"ltsrad",page:null}],frontMatter:{slug:"spr-and-cups-multicast-vulnerability",title:"Locking Down Multicast Services with SPR",authors:["ltsrad"],tags:["firewall","multicast"]},unlisted:!1,prevItem:{title:"Security Fixes & Conntrack Hardening in SPR",permalink:"/pages/blog/spr-conntrack-hardening"},nextItem:{title:"Locking Down Docker Networks with SPR",permalink:"/pages/blog/docker-networking-containment"}},l={authorsImageUrls:[void 0]},c=[{value:"Overview",id:"overview",level:2},{value:"Understanding Multicast &amp; Risks",id:"understanding-multicast--risks",level:2},{value:"WiFi Group Keys Can Transmit Multicast Without The Access Point",id:"wifi-group-keys-can-transmit-multicast-without-the-access-point",level:2},{value:"How SPR Performs Multicast Between Client Stations",id:"how-spr-performs-multicast-between-client-stations",level:2},{value:"How SPR Impacts the Recent CUPS Vulnerabilities",id:"how-spr-impacts-the-recent-cups-vulnerabilities",level:2},{value:"Multicast Roadmap",id:"multicast-roadmap",level:2}];function h(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Here is an overview of how SPR helps defend users against attacks with multicast services. The capabilities let SPR users enjoy the benefits of multicast while also being able to constrain the attack surfaces to trusted devices only."}),"\n",(0,s.jsx)(t.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Every WiFi device is placed on its own VLAN and has a unique Group Key blocking Direct Station to Station Multicast traffic"}),"\n",(0,s.jsx)(t.li,{children:"We employ a configurable multicast proxy to relay whitelisted multicast services. It support mDNS and SSDP by default for ease of use. The multicast proxy and mDNS & SSDP relaying can be completely turned off though."}),"\n",(0,s.jsxs)(t.li,{children:["We also support ",(0,s.jsx)(t.a,{href:"/pages/docs/guides/firewall#multicast-proxy",children:"setting a tag for multicast services"})," to limit relaying traffic to only devices with the same tag applied."]}),"\n"]}),"\n",(0,s.jsx)(t.h2,{id:"understanding-multicast--risks",children:"Understanding Multicast & Risks"}),"\n",(0,s.jsx)(t.p,{children:"IP-Based multicast networking allows sending packets to multiple devices with a single packet.\nIt differs than the broadcast traffic because clients can additionally choose to subscribe to a group and let a router intelligently forward packets to group members, using protocols such as IGMP."}),"\n",(0,s.jsx)(t.p,{children:"Multicast services tend to only be reachable as roughly 'one-hop' away, meaning an attacker must be network adjacent to a victim to carry out an attack. The packets are one-way, so TCP is not possible but UDP is. Furthermore firewalls can validate that multicast traffic has TTLS set to 1, meaning they won't be forwarded."}),"\n",(0,s.jsxs)(t.p,{children:["That said, multicast has been a source of security holes in the past, in Avahi, mDNSResponder, and more recently in CUPS: ",(0,s.jsx)(t.a,{href:"https://github.com/RickdeJager/cupshax/blob/main/cupshax.py",children:"where a multicast trigger affected Apple devices, among others"}),";  when users attempt to use maliciously injected printer profiles."]}),"\n",(0,s.jsx)(t.h2,{id:"wifi-group-keys-can-transmit-multicast-without-the-access-point",children:"WiFi Group Keys Can Transmit Multicast Without The Access Point"}),"\n",(0,s.jsx)(t.p,{children:"One way to WiFi Clients get Multicast Packets on an encrypted Access Point are directly from other clients with the Group Key that is shared."}),"\n",(0,s.jsx)(t.p,{children:"Or, they can get the packets with unicast, and receive multicast packets when the Access Point intelligently forwards the packets only to the clients that joined the group destination. This method is preferred for maximizing battery life on nearby devices."}),"\n",(0,s.jsxs)(t.admonition,{type:"warning",children:[(0,s.jsx)(t.p,{children:"Critically, this means that clients can send multicast to one-another without the access point or router bridging/forwarding packets."}),(0,s.jsx)(t.p,{children:"Actually there's 3 ways to send a multicast packet to consider."}),(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsx)(t.li,{children:"Use the shared GTK directly from Client Station to Client Station"}),"\n",(0,s.jsxs)(t.li,{children:["Send to AP. Set the 'DA' to the victim MAC address and 'RA' as the Access Point BSSID, for layer 2 bridging. This is the default way stations talk to each other over unicast packets on a subnet without routing. ",(0,s.jsx)(t.code,{children:"ap_isolate="})," blocks this method."]}),"\n",(0,s.jsx)(t.li,{children:"Assuming the multicast listener fails to filter for the multicast destination IP: Send to the AP again. This time set the 'DA' and 'RA' as the Access Point BSSID and rely on layer 3 IP forwarding to send to the client's IP. For UDP this works great but the round trip may not happen unless the peer is on a wired medium. Most consumer WiFi Devices are vulnerable to this in their Guest Network Isolation feature. MAC/IP filtering on the firewall helps stop this."}),"\n"]})]}),"\n",(0,s.jsx)(t.h2,{id:"how-spr-performs-multicast-between-client-stations",children:"How SPR Performs Multicast Between Client Stations"}),"\n",(0,s.jsx)(t.p,{children:"In hostapd we set the following key features:"}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{children:"per_sta_vif=1 # one vlan per device\nap_isolate=1 # drop layer 2 bridging\nmulticast_to_unicast=1 # since each GTK is unique anyway\n"})}),"\n",(0,s.jsx)(t.p,{children:"Part of what makes this all work without losing functionality is that each device is dropped into its own subnet. This means that when devices do want to communicate with one-another they will not expect layer-2 bridging to occur but instead route to each other via layer 3 forwarding."}),"\n",(0,s.jsxs)(t.p,{children:["To re-enable multicast we use a ",(0,s.jsx)(t.a,{href:"https://github.com/spr-networks/super/tree/main/multicast_udp_proxy",children:"multicast udp proxy"})," written in Golang. This will configurabily forward SSDP and mDNS by default."]}),"\n",(0,s.jsxs)(t.p,{children:["Users can ",(0,s.jsx)(t.a,{href:"/pages/docs/guides/firewall#multicast-proxy",children:"define new services to relay, disable multicast services altogether, or apply a tag"})," to filter the multicast to designated clients only."]}),"\n",(0,s.jsx)(t.h2,{id:"how-spr-impacts-the-recent-cups-vulnerabilities",children:"How SPR Impacts the Recent CUPS Vulnerabilities"}),"\n",(0,s.jsxs)(t.p,{children:["By default, SPR has mDNS on. This means that unless a user has turned it off, a malicious device could advertise to ",(0,s.jsx)(t.a,{href:"https://github.com/RickdeJager/cupshax/blob/main/cupshax.py#L29",children:"automatically install a malicious foomatic profile"}),"."]}),"\n",(0,s.jsxs)(t.p,{children:["However, unless a victim device is also in the same group as the attacking device, or the victim has a ",(0,s.jsx)(t.code,{children:"lan"})," policy set, the victim will be unable to retrieve the malicious printer profile, blocking the attack."]}),"\n",(0,s.jsx)(t.h2,{id:"multicast-roadmap",children:"Multicast Roadmap"}),"\n",(0,s.jsx)(t.p,{children:"In the future we plan to continue to make multicast management more seamless and improve visibility and workflows."}),"\n",(0,s.jsx)(t.p,{children:"One area of improvement in particular is Wireguard support so that devices can potentially multicast to each other across the VPN if a user chooses the functionality."}),"\n",(0,s.jsxs)(t.p,{children:["Have a feature idea or request? ",(0,s.jsx)(t.a,{href:"/pages/docs/contact",children:"Let us know!"}),"."]})]})}function u(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},11151:(e,t,i)=>{i.d(t,{Z:()=>o,a:()=>r});var s=i(67294);const a={},n=s.createContext(a);function r(e){const t=s.useContext(n);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(n.Provider,{value:t},e.children)}}}]);