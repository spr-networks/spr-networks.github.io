<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Security Fixes &amp; Conntrack Hardening in SPR | SPR</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://www.supernetworks.org/pages/blog/spr-conntrack-hardening"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Security Fixes &amp; Conntrack Hardening in SPR | SPR"><meta data-rh="true" name="description" content="Anvil Secure recently published a post and whitepaper covering conntrack flaws that are common with many linux routers and linux &quot;multihomed&quot; devices. In this post we&#x27;ll cover SPR, how our process mitigated the highest risk vulnerabilities, how we fixed the rest and other improvements we&#x27;re making to be resilient against attacks like this in the future."><meta data-rh="true" property="og:description" content="Anvil Secure recently published a post and whitepaper covering conntrack flaws that are common with many linux routers and linux &quot;multihomed&quot; devices. In this post we&#x27;ll cover SPR, how our process mitigated the highest risk vulnerabilities, how we fixed the rest and other improvements we&#x27;re making to be resilient against attacks like this in the future."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-10-16T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://twitter.com/defendtheworld"><meta data-rh="true" property="article:tag" content="firewall,conntrack"><link data-rh="true" rel="icon" href="/pages/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://www.supernetworks.org/pages/blog/spr-conntrack-hardening"><link data-rh="true" rel="alternate" href="https://www.supernetworks.org/pages/blog/spr-conntrack-hardening" hreflang="en"><link data-rh="true" rel="alternate" href="https://www.supernetworks.org/pages/blog/spr-conntrack-hardening" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://6J0ST5YCC4-dsn.algolia.net" crossorigin="anonymous"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://www.supernetworks.org/pages/blog/spr-conntrack-hardening","mainEntityOfPage":"https://www.supernetworks.org/pages/blog/spr-conntrack-hardening","url":"https://www.supernetworks.org/pages/blog/spr-conntrack-hardening","headline":"Security Fixes & Conntrack Hardening in SPR","name":"Security Fixes & Conntrack Hardening in SPR","description":"Anvil Secure recently published a post and whitepaper covering conntrack flaws that are common with many linux routers and linux \"multihomed\" devices. In this post we'll cover SPR, how our process mitigated the highest risk vulnerabilities, how we fixed the rest and other improvements we're making to be resilient against attacks like this in the future.","datePublished":"2024-10-16T00:00:00.000Z","author":{"@type":"Person","name":"Alex Radocea","url":"https://twitter.com/defendtheworld"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://www.supernetworks.org/pages/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/pages/blog/rss.xml" title="SPR RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/pages/blog/atom.xml" title="SPR Atom Feed">





<link rel="search" type="application/opensearchdescription+xml" title="SPR" href="/pages/opensearch.xml">



<link rel="preconnect" href="https://us.i.posthog.com">
<script>!function(t,e){var o,s,r,a;e.__SV||(window.posthog=e,e._i=[],e.init=function(i,n,p){function c(t,e){var o=e.split(".");2==o.length&&(t=t[o[0]],e=o[1]),t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}}(r=t.createElement("script")).type="text/javascript",r.async=!0,r.src=n.api_host.replace(".i.posthog.com","-assets.i.posthog.com")+"/static/array.js",(a=t.getElementsByTagName("script")[0]).parentNode.insertBefore(r,a);var g=e;for(void 0!==p?g=e[p]=[]:p="posthog",g.people=g.people||[],g.toString=function(t){var e="posthog";return"posthog"!==p&&(e+="."+p),t||(e+=" (stub)"),e},g.people.toString=function(){return g.toString(1)+".people (stub)"},o="capture identify alias people.set people.set_once set_config register register_once unregister opt_out_capturing has_opted_out_capturing opt_in_capturing reset isFeatureEnabled onFeatureFlags getFeatureFlag getFeatureFlagPayload reloadFeatureFlags group updateEarlyAccessFeatureEnrollment getEarlyAccessFeatures getActiveMatchingSurveys getSurveys onSessionId".split(" "),s=0;s<o.length;s++)c(g,o[s]);e._i.push([i,n,p])},e.__SV=1)}(document,window.posthog||[]),posthog.init("phc_wHrv9J5yEKPecDYT9ligBWKlIi2LBDL7I4heu69ayOT",{api_host:"https://us.i.posthog.com",id:"default"})</script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="true">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&amp;display=swap"><link rel="stylesheet" href="/pages/assets/css/styles.3b223375.css">
<script src="/pages/assets/js/runtime~main.cd3e283b.js" defer="defer"></script>
<script src="/pages/assets/js/main.523273cb.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><header class="main-site-header gradient-bg text-white py-4 relative z-[60]"><style>
        .main-site-header a {
          text-decoration: none !important;
          color: white !important;
        }
        .main-site-header ul {
          list-style: none !important;
          padding: 0 !important;
          margin: 0 !important;
        }
        .main-site-header li {
          list-style: none !important;
        }
        .gradient-bg {
          background: linear-gradient(135deg, #1a202c, #2d3748);
        }
        .gradient-text {
          background: -webkit-linear-gradient(45deg, #4fd1c5, #6ee7b7);
          -webkit-background-clip: text;
          -webkit-text-fill-color: transparent;
        }
        .nav-item {
          position: relative;
        }
        .nav-item:after {
          content: '';
          position: absolute;
          left: 0;
          bottom: 0;
          width: 100%;
          height: 2px;
          background: linear-gradient(45deg, #4fd1c5, #6ee7b7);
          transform: scaleX(0);
          transform-origin: left;
          transition: transform 0.3s ease;
        }
        .nav-item:hover:after {
          transform: scaleX(1);
        }
        .dropdown:hover .dropdown-menu {
          display: block;
        }
        .dropdown-menu {
          display: none;
          position: absolute;
          background-color: #2d3748;
          min-width: 200px;
          box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
          z-index: 1;
          border-radius: 4px;
          top: 100%;
          left: 0;
        }
        .dropdown-menu li {
          padding: 0.5rem 1rem;
        }
        .dropdown-menu li:hover {
          background-color: #1a202c;
        }
        .dropdown-menu a {
          color: #e2e8f0 !important;
        }
        .dropdown-menu a:hover {
          color: #38bdf8 !important;
        }
      </style><div class="container mx-auto px-4"><div class="flex flex-col md:flex-row md:justify-between md:items-center"><div class="flex justify-between items-center"><a href="https://www.supernetworks.org" class="text-lg font-semibold tracking-tight"><span class="text-2xl font-bold gradient-text">SPR</span> by Supernetworks</a><div class="fixed top-4 right-4 md:right-10 z-[70]" style="position:fixed;top:1rem;right:1rem;z-index:70"><a href="https://www.supernetworks.org/compute-board.html" style="background-color:#10b981;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background-color 0.3s"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg></a></div></div><nav class="hidden md:flex md:items-center md:space-x-8"><ul class="flex flex-col md:flex-row mt-4 space-y-4 md:mt-0 md:space-y-0 md:space-x-8 text-sm font-normal"><li><a href="https://www.supernetworks.org/#products" class="hover:text-sky-400 transition duration-300 nav-item">Products</a></li><li><a href="https://www.supernetworks.org/#how-to-use" class="hover:text-sky-400 transition duration-300 nav-item">Solutions</a></li><li><div class="dropdown inline-block relative"><a href="https://www.supernetworks.org/features.html" class="inline-flex items-center hover:text-sky-400 transition duration-300 nav-item"><span class="mr-1">Features</span><svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"></path></svg></a><ul class="dropdown-menu"><li><a class="block whitespace-no-wrap hover:text-sky-400" href="/pages/docs/guides/dns">Ad Block</a></li><li><a class="block whitespace-no-wrap hover:text-sky-400" href="/pages/docs/guides/firewall">Firewall &amp; Routing</a></li><li><a class="block whitespace-no-wrap hover:text-sky-400" href="/pages/docs/guides/alerts">Alerts</a></li><li><a class="block whitespace-no-wrap hover:text-sky-400" href="https://www.supernetworks.org/#vpn">VPN</a></li><li><a class="block whitespace-no-wrap hover:text-sky-400" href="/pages/docs/guides/logs">Traffic Monitoring</a></li><li><a class="block whitespace-no-wrap hover:text-sky-400" href="/pages/docs/guides/plugins">Plugins</a></li></ul></div></li><li><a href="https://www.supernetworks.org/plus.html" class="hover:text-sky-400 transition duration-300 nav-item">PLUS</a></li><li><a href="/pages/docs/faq" class="hover:text-sky-400 transition duration-300 nav-item">FAQ</a></li><li><a href="/pages/blog" class="hover:text-sky-400 transition duration-300 nav-item">Blog</a></li><li class="md:pl-8"><a class="hover:underline flex items-center" href="https://github.com/spr-networks/super/"><img src="/pages/img/github.svg" alt="GitHub" style="width:20px;height:20px;filter:invert(100%) brightness(200%);display:block"></a></li><li><a class="hover:underline flex items-center" href="https://discord.gg/EUjTKJPPAX"><img src="/pages/img/discord.svg" alt="Discord" style="width:20px;height:20px;filter:invert(100%) brightness(200%);display:block"></a></li></ul></nav></div></div></header><div style="position:relative;z-index:50"><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://www.supernetworks.org/" target="_self" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/pages/img/logo.png" alt="Secure Programmable Router" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/pages/img/logo.png" alt="Secure Programmable Router" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">SPR</b></a><a class="navbar__item navbar__link" href="/pages/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/pages/docs/setup_guides/setup_run_spr">Setup Guide</a><a class="navbar__item navbar__link" href="/pages/articles">Articles</a><a class="navbar__item navbar__link" href="/pages/api/0">API</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pages/blog">Blog</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/spr-networks/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">SPR GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav></div><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2025</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/the-bitchat-update">The Bitchat Update</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-poe-router-3gbps-throughput">Real-World Test: PoE+ Router Pushes 3+ Gbps Simultaneously on WiFi 6 &amp; 2.5GbE</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/agentic-insecurity-vibes-on-bitchat">Identity Is A Bitchat Challenge (MITM Flaw)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/macos-smb-flaws">SMB Flaws in macOS</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/guest-ssid-on-spr">We&#x27;ve Added Guest SSID Support</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/google-removed-ublock">Google Just Removed uBlock Origin from the Chrome Store Today!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/wpa3-needs-decoyauth">Advancing DecoyAuth is Key to Making WiFi &amp; WPA3 More Secure</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/sleep-better-backdoors">How to sleep better when your bed is a backdoor</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/pages/blog/spr-conntrack-hardening">Security Fixes &amp; Conntrack Hardening in SPR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-and-cups-multicast-vulnerability">Locking Down Multicast Services with SPR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/docker-networking-containment">Locking Down Docker Networks with SPR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/80211-authentication-association-authorization-wifi">Authentication, Association, and Authorization in 802.11 WiFi</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/loading-your-own-rust-kernel-modules">Loading Out of Tree Rust in Linux</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/bssid-randomization">BSSID Randomization</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/pi5-hardware-2024">PI5 Hats and More, Unleashing the Power of Modular Router Hardware</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/midnightsun-qualifiers-2024-dragonfly">Dragonfly Pake</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-tailscale-integration">SPR Tailscale</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/beacon-double-free-inet-wireless-daemon-CVE-2024-28084">Beacon Double Free in IWD</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/federal-focus-memory-corruption-2024">Software Safety Looks Different From The Other Side</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/isoon-wifi-exploitation-2024">What the I-Soon Leak Tells Us About WiFi Hacking</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-2024-alerts">Alerts to Improve Network Visibility</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2023</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-2023-in-review">2023 Year in Review</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-nzyme-tap">Loading an nzyme tap on SPR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-mitmproxy">Transparent Socket Forwarding with SPR and MITMProxy</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-nexmon">Loading up nexmon on a RPI4 with SPR</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/barely-ap-surfaces">Attack Surface Reduction Research (Part 1)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/scapy-revfrag">One Weird Trick to fix your CTF Payloads</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/virtual-spr-1click">How to use the SPR 1-click install on DigitalOcean</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/ios-app-released">SPR Now Available on the iOS App Store</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/barely-ap">Barely AP is Almost an Access Point</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr-turtles-march">March 2023&#x27;s Turtles Challenge</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/january-2023-turtles">January 2023&#x27;s Turtles Challenge</a></li></ul></div><div role="group"><h3 class="yearGroupHeading_rMGB">2022</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/virtual-spr-on-a-gcloud-tier-free-instance">Run Virtual SPR on a Google Cloud Free Tier Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/virtual-spr-on-a-aws-micro-tier-instance">Run Virtual SPR on a AWS Micro Tier Instance</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/virtual-spr-on-a-digital-ocean-droplet">Run Virtual SPR on a DigitalOcean Droplet</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/virtual SPR">SPR in the cloud</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/secure router chaining">Securely Chaining Routers</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/multipsk and wpa3">SPR Supports WPA3 with Multiple Passwords</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/wifi6">Gigabit WiFi with SPR &amp; The 4x4 MT7915</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/spr_mini_pc">Running SPR on a Mini PC with WiFi 6</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/UI Push">Supernetworks just Released a React User Interface</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/pages/blog/first-blog-post">Announcing The SPR Project</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Security Fixes &amp; Conntrack Hardening in SPR</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-10-16T00:00:00.000Z">October 16, 2024</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://twitter.com/defendtheworld" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Alex Radocea</span></a></div><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>Anvil Secure recently published a <a href="https://anvilsecure.com/blog/spoofing-internal-packets-for-multihomed-linux-devices.html" target="_blank" rel="noopener noreferrer">post</a> and <a href="https://www.anvilsecure.com/wp-content/uploads/2024/10/Conntrack-Spoofing-Internal-Packets-Whitepaper-1.pdf" target="_blank" rel="noopener noreferrer">whitepaper</a> covering conntrack flaws that are common with many linux routers and linux &quot;multihomed&quot; devices. In this post we&#x27;ll cover SPR, how our process mitigated the highest risk vulnerabilities, how we fixed the rest and other improvements we&#x27;re making to be resilient against attacks like this in the future.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p><a href="https://conntrack-tools.netfilter.org/manual.html" target="_blank" rel="noopener noreferrer">Conntrack</a> is part of Linux Netfilter and is an integral part of a stateful firewall for allowing Network Address Translation on a network.  A router uses it to allow clients to establish connections through the uplink interfaces.</p>
<p>Anvil Secure published details on how devices often fail to lock down their firewalls correctly since Conntrack operates at layer 3. External attackers that are one hop away can abuse this to spoof IP addresses and send traffic to internal interfaces on devices and routers for an established connection managed with conntrack.  For most of our users, this limits the attack to compromised or hostile ISP providers, which is an uncommon (but not unheard of attack vector).  However, since the WiFi Pod can be used as a travel router, it&#x27;s important to us that they are can withstand being attached to a hostile network.</p>
<p>The riskiest of the attacks happen to not affect SPR.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="potential-attacks">Potential Attacks<a href="#potential-attacks" class="hash-link" aria-label="Direct link to Potential Attacks" title="Direct link to Potential Attacks">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-1-the-uplink-interface-reaching-internal-services-on-the-router-that-are-not-meant-to-be-accessible-to-the-outside">Attack #1: The uplink interface reaching internal services on the router that are not meant to be accessible to the outside<a href="#attack-1-the-uplink-interface-reaching-internal-services-on-the-router-that-are-not-meant-to-be-accessible-to-the-outside" class="hash-link" aria-label="Direct link to Attack #1: The uplink interface reaching internal services on the router that are not meant to be accessible to the outside" title="Direct link to Attack #1: The uplink interface reaching internal services on the router that are not meant to be accessible to the outside">​</a></h3>
<ul>
<li>Severity: High</li>
<li>Status: Not Vulnerable</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>SPR&#x27;s firewall explicitly matches interfaces to the service ports on the router, so the uplink interface can only connect to service ports if they&#x27;re explicitly set to be externally facing, even with IP spoofing.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-2-punching-holes-in-a-router-firewall-with-nat-pmp">Attack #2: Punching holes in a router firewall with NAT-PMP<a href="#attack-2-punching-holes-in-a-router-firewall-with-nat-pmp" class="hash-link" aria-label="Direct link to Attack #2: Punching holes in a router firewall with NAT-PMP" title="Direct link to Attack #2: Punching holes in a router firewall with NAT-PMP">​</a></h3>
<ul>
<li>Severity: High</li>
<li>Status: Not Vulnerable</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>SPR does not run NAT-PMP.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-3-ip-spoofing-on-external-service-ports">Attack #3: IP Spoofing On External Service Ports<a href="#attack-3-ip-spoofing-on-external-service-ports" class="hash-link" aria-label="Direct link to Attack #3: IP Spoofing On External Service Ports" title="Direct link to Attack #3: IP Spoofing On External Service Ports">​</a></h3>
<ul>
<li>Severity: Medium</li>
<li>Status: Patched in v1.0.1</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The uplink connection to an externally exposed service port could spoof the IP address to match an established connection and blindly send UDP packets by spamming source ports or the same for TCP (if they can guess the sequence numbers plus the source port). This traffic could then present itself on a connection between SPR and a LAN client.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-4-vlan-routing-with-spoofed-ips-against-service-ports">Attack #4: VLAN Routing with Spoofed IPs against Service Ports<a href="#attack-4-vlan-routing-with-spoofed-ips-against-service-ports" class="hash-link" aria-label="Direct link to Attack #4: VLAN Routing with Spoofed IPs against Service Ports" title="Direct link to Attack #4: VLAN Routing with Spoofed IPs against Service Ports">​</a></h3>
<ul>
<li>Severity: Low</li>
<li>Status: Patched in v1.0.1</li>
</ul>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>Similarly, VLANs could also perform the same attack against each other internally to attempt to inject traffic into an established connection.</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="attack-indicators">Attack Indicators<a href="#attack-indicators" class="hash-link" aria-label="Direct link to Attack Indicators" title="Direct link to Attack Indicators">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>SPR logs dropped packets and has <a href="/pages/docs/guides/alerts">alerts</a> for MAC spoofing. In the process of running the attack, the source ports must be enumerated to match the established internal connection. This would create <code>nft:drop:mac</code> events when the attacker scans for an established source port. Users can see dropped packets under the alerts pane. To filter the external interface, the filter can be set to <code>Event.InDev==&quot;eth0&quot;</code> for example if the uplink interface is <code>eth0</code>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="on-vpndocker">On VPN/Docker<a href="#on-vpndocker" class="hash-link" aria-label="Direct link to On VPN/Docker" title="Direct link to On VPN/Docker">​</a></h2>
<p><a href="https://citizenlab.ca/2024/07/vulnerabilities-in-vpns-paper-presented-at-the-privacy-enhancing-technologies-symposium-2024/" target="_blank" rel="noopener noreferrer">Port Shadow</a> attacks are a similar issue. On a shared VPN host with multiple users a malicious adversary could use the VPN&#x27;s destination port as the source port to confuse stateful firewall rules into redirecting traffic to set up a MITM attack. SPR hardens against this attack by blocking source ports on the <a href="https://github.com/spr-networks/super/blob/1f3799ffb82dd758bb9936c05e8812bbe5870063/base/scripts/nft_rules.sh#L256" target="_blank" rel="noopener noreferrer">wireguard port</a></p>
<p>SPR also runs as a VPN under a virtualized docker network. In this scenario SPR does not manage the host firewall, and relies on Docker&#x27;s host rules for forwarding services. We cover network attacks against <a href="https://www.supernetworks.org/pages/blog/docker-networking-containment" target="_blank" rel="noopener noreferrer">Container Networks</a> in a prior post.  In SPR we harden against attacks on Docker&#x27;s overly premissive networking rules by <a href="https://github.com/spr-networks/super/blob/1f3799ffb82dd758bb9936c05e8812bbe5870063/base/scripts/nft_rules.sh#L271" target="_blank" rel="noopener noreferrer">limiting API access to the container network</a> interface and subnets.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="on-wi-fi">On Wi-Fi<a href="#on-wi-fi" class="hash-link" aria-label="Direct link to On Wi-Fi" title="Direct link to On Wi-Fi">​</a></h2>
<p>Anvils&#x27; writeups have great information, and one especially good gem of wisdom in the whitepaper is as follows:</p>
<p><strong>&quot;For example, on NAT router[s] supporting both Wi‑Fi and Ethernet, a communications between two Wi‑Fi clients are likely to stay on the Wi‑Fi chip.&quot;</strong></p>
<p>This is because with WPA the typical operation is that when station PeerA transmits to PeerB it will encrypt with it&#x27;s unicast pariwise temporal key (PTK) and send a packet to the AP with Receiver Address(RA)=BSSID and Destination Address (DA). The AP re-encryptes the traffic with PeerB&#x27;s PTK and sends it without going through the OS networking stack.</p>
<p>Many Guest networks rely on this bridging to be blocked when hostapd has &quot;ap_isolate=1&quot; enabled. Unfortunately most setups don&#x27;t do any hardening against routing. So if an adversary instead transmits with RA=DA=BSSID and the IP Destination of PeerB, the router will happily route the packet to PeerB over the networking stack, and then re-encrypt the traffic with the PeerB PTK .</p>
<p>As this next part from the whitepaper mentions, bridging mediums is even more susceptible since they must go through the routing tables (and in turn imply a round trip is possible with spoofing attacks to also receive traffic).</p>
<p><strong>&quot;A Wi‑Fi client communicating with an Ethernet host on the other hand, could pass through the NAT router via the bridge&quot;</strong></p>
<p>In SPR we defend against WiFi-based attacks as follows:</p>
<ul>
<li>We set ap_isolate=1 to avoid L2 bridging in the chipset where the AP re-encrypts unicast traffic to the other peer</li>
<li>We use Per-Station VLANs with unique group keys for each to avoid GTK-based communications bypassing the AP</li>
<li>We support unique device WPA2/3 passwords to block rogue AP attacks as well as passive key derivation on WPA2.</li>
<li>We use MAC filters to stop IP spoofing without knowing the spoofed device&#x27;s WiFi password &amp; MAC address.</li>
</ul>
<p>With conntrack we had some exposure  (#4 above), where established connections could be spoofed into SPR&#x27;s service ports across VLANs to bypass the MAC filter.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-fixes">The fixes<a href="#the-fixes" class="hash-link" aria-label="Direct link to The fixes" title="Direct link to The fixes">​</a></h2>
<p>To address the issues we&#x27;ve added rules to explicitly block LAN IP ranges from/to the uplink interfaces on the INPUT tables [1].
Secondly we&#x27;ve moved the MAC filters [2] before the conntrack rules.</p>
<div class="language-diff codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-diff codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">diff --git a/base/scripts/nft_rules.sh b/base/scripts/nft_rules.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">index 7b96abd6..b03545fd 100755</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">--- a/base/scripts/nft_rules.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+++ b/base/scripts/nft_rules.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -1,8 +1,5 @@</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> #!/bin/bash</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-#TBD:</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-#- can F_EST_RELATED be moved past MAC spoof check</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> # Disable forwarding</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> sysctl net.ipv4.ip_forward=0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -246,6 +243,10 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     iifname @uplink_interfaces log prefix &quot;wan:in &quot; group 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     iifname != @uplink_interfaces log prefix &quot;lan:in &quot; group 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    # block lan ranges from uplink interfaces #[1]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    iifname @uplink_interfaces ip saddr @supernetworks goto DROPLOGINP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    iifname @uplink_interfaces ip daddr @supernetworks goto DROPLOGINP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Drop input from the site to site output interfaces. They are only a sink,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Not a source that can connect into SPR services</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     counter iifname @outbound_sites goto DROPLOGINP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -270,7 +271,6 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     $(if [ &quot;$VIRTUAL_SPR_API_INTERNET&quot; ]; then echo &quot;&quot; ;  elif [[ &quot;$WAN_NET&quot; ]]; then echo &quot;counter iifname @uplink_interfaces tcp dport 80, 443 ip saddr != $WAN_NET drop&quot;; fi)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     $(if [ &quot;$VIRTUAL_SPR_API_INTERNET&quot; ]; then echo &quot;&quot; ;  elif [[ &quot;$WAN_NET&quot; ]]; then echo &quot;counter iifname @uplink_interfaces udp dport 53, 67 ip saddr != $WAN_NET drop&quot;; fi)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-    counter jump F_EST_RELATED # [2]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # DHCP Allow rules</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Wired lan</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -284,6 +284,8 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Prevent MAC Spoofing from LANIF, wired interfaces</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     iifname @lan_interfaces jump DROP_MAC_SPOOF</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    counter jump F_EST_RELATED # [2]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # DNS Allow rules</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Docker can DNS</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     $(if [ &quot;$DOCKERIF&quot; ]; then echo &quot;iif $DOCKERIF ip saddr $DOCKERNET udp dport 53 counter accept&quot;; fi)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -343,6 +345,15 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Allow DNAT for port forwarding</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     counter ct status dnat accept</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    # block lan ranges from uplink interfaces</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    # uplinks can not NAT FROM @supernetworks source addresses</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    iifname @uplink_interfaces ip saddr @supernetworks goto DROPLOGFWD</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    # uplinks can not receive @supernetworks destination addresses</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    oifname @uplink_interfaces ip daddr @supernetworks goto DROPLOGFWD</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    # Verify MAC addresses for LANIF/WIPHYs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    iifname @lan_interfaces jump DROP_MAC_SPOOF [2]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     counter jump F_EST_RELATED</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # Do not forward from uplink interfaces after dnat</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -355,8 +366,6 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     oifname @uplink_interfaces log prefix &quot;wan:out &quot; group 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     oifname != @uplink_interfaces log prefix &quot;lan:out &quot; group 0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-    # Verify MAC addresses for LANIF/WIPHYs</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">-    iifname @lan_interfaces jump DROP_MAC_SPOOF  [2]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # After MAC SPOOF check, but before rfc1918 check</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     # These rules allow permits via endpoint verdict maps</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -432,6 +441,8 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   chain OUTPUT {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     type filter hook output priority 0; policy accept</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    oifname @uplink_interfaces ip daddr @supernetworks goto DROPLOGOUTP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    oifname @uplink_interfaces ip saddr @supernetworks goto DROPLOGOUTP</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   chain DROPLOGFWD {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -444,6 +455,11 @@ table inet filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     counter drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+  chain DROPLOGOUTP {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    counter log prefix &quot;drop:output &quot; group 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+    counter drop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+  }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   chain F_EST_RELATED {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     ip protocol udp ct state related,established counter accept</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     ip protocol tcp ct state related,established counter accept</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">@@ -472,11 +488,6 @@ table inet nat {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     $(if [ &quot;$LANIF&quot; ]; then echo &quot;elements = { $LANIF }&quot; ; fi )</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/pages/blog/tags/firewall">firewall</a></li><li class="tag_QGVx"><a rel="tag" class="tag_zVej tagRegular_sFm0" href="/pages/blog/tags/conntrack">conntrack</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/pages/blog/sleep-better-backdoors"><div class="pagination-nav__sublabel">Newer post</div><div class="pagination-nav__label">How to sleep better when your bed is a backdoor</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pages/blog/spr-and-cups-multicast-vulnerability"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">Locking Down Multicast Services with SPR</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#potential-attacks" class="table-of-contents__link toc-highlight">Potential Attacks</a><ul><li><a href="#attack-1-the-uplink-interface-reaching-internal-services-on-the-router-that-are-not-meant-to-be-accessible-to-the-outside" class="table-of-contents__link toc-highlight">Attack #1: The uplink interface reaching internal services on the router that are not meant to be accessible to the outside</a></li><li><a href="#attack-2-punching-holes-in-a-router-firewall-with-nat-pmp" class="table-of-contents__link toc-highlight">Attack #2: Punching holes in a router firewall with NAT-PMP</a></li><li><a href="#attack-3-ip-spoofing-on-external-service-ports" class="table-of-contents__link toc-highlight">Attack #3: IP Spoofing On External Service Ports</a></li><li><a href="#attack-4-vlan-routing-with-spoofed-ips-against-service-ports" class="table-of-contents__link toc-highlight">Attack #4: VLAN Routing with Spoofed IPs against Service Ports</a></li><li><a href="#attack-indicators" class="table-of-contents__link toc-highlight">Attack Indicators</a></li></ul></li><li><a href="#on-vpndocker" class="table-of-contents__link toc-highlight">On VPN/Docker</a></li><li><a href="#on-wi-fi" class="table-of-contents__link toc-highlight">On Wi-Fi</a></li><li><a href="#the-fixes" class="table-of-contents__link toc-highlight">The fixes</a></li></ul></div></div></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">SPR Links</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pages/">SPR Homepage</a></li><li class="footer__item"><a class="footer__link-item" href="/pages/docs/intro">Documentation</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.gg/EUjTKJPPAX" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://twitter.com/spr_networks" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title"> </div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pages/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/spr-networks/" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/pages/docs/contact">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Supernetworks, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script>!function(){function t(){const t=document.querySelectorAll("div.markdown");Array.from(t).filter(t=>"blogPost"===t.parentNode.getAttribute("itemprop")).forEach(t=>{if(!t.nextSibling||!t.nextSibling.classList.contains("custom-section")){const e=document.createElement("div");e.classList.add("custom-section"),e.innerHTML='\n          <br/>\n<br/>\n<h3>Connect with the SPR Community</h3>\n<ul>\n  <li><b>Get in the loop</b>: <a href="https://sendfox.com/supernetworks">Subscribe</a> to our Newsletter</li>\n  <li><b>Collaborate</b>:  <a href="https://github.com/spr-networks/super">Check out</a> our GitHub</li>\n  <li><b>Chat with us</b>: <a href="https://discord.gg/EUjTKJPPAX">Join our Discord</a> or <a href="https://twitter.com/spr_networks">Follow us</a> on Twitter</li>\n</ul>\n<br/>\n\n        ',t.parentNode.insertBefore(e.cloneNode(!0),t.nextSibling)}})}new MutationObserver((e,o)=>{document.querySelector("article")&&t()}).observe(document,{childList:!0,subtree:!0}),t()}()</script></body>
</html>